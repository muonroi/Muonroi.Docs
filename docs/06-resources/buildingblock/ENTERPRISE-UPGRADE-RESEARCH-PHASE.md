# Enterprise Upgrade Research Phase

Date: 2026-02-21
Owner: Muonroi.BuildingBlock
Scope: Licensed + Enterprise roadmap after current RBAC, Multi-tenant, Rule Engine hardening.

## 1. Current Baseline

Existing upgrade tracks already completed a strong foundation:

- RBAC+ hardening and license gate (`advanced-auth`).
- Multi-tenant hardening and tenant consistency across HTTP/gRPC/SignalR/JWT.
- Rule-engine security hardening, signature checks, and premium gating.
- Tiered license runtime (Free/Licensed/Enterprise) with policy and server-validation components.

Primary references:

- `ADVANCED_AUTH_RBAC_PLUS_UPGRADE_PLAN.md`
- `MULTI_TENANCY_UPGRADE_PLAN.md`
- `RULE_ENGINE_UPGRADE_PLAN.md`
- `DYNAMIC_BUSINESS_LOGIC_CLOUD_ROADMAP.md`

External architecture references used for E0/E3 direction:

- OpenFGA model design docs: https://openfga.dev/docs/modeling/getting-started
- OPA policy + externalized decision docs: https://www.openpolicyagent.org/docs/policy-language
- OPA bundle distribution docs: https://www.openpolicyagent.org/docs/management-bundles
- Keycloak authorization services + policy enforcer docs:
  https://www.keycloak.org/docs/latest/authorization_services/index.html
- OAuth 2.0 scope semantics (RFC 6749): https://datatracker.ietf.org/doc/html/rfc6749#section-3.3

## 2. Enterprise Gaps Still Open

Despite strong runtime guards, enterprise buyers still need:

- Unified entitlement model (capability profile) to avoid fragile per-action feature keys.
- Control plane for license/policy lifecycle (issue, revoke, rotate, rollout, rollback).
- Compliance-grade audit evidence (immutable export and chain of custody).
- Strong production posture defaults (signed policy required, fail-closed where needed).
- Centralized authorization option for microservices (PDP mode).
- Operational enterprise package (SLO, upgrade safety checks, support workflows).

## 3. Strategic Direction

Build Enterprise as a governance platform, not only a feature unlock.

Value proposition:

- Free: fast developer adoption.
- Licensed: premium module unlock for product teams.
- Enterprise: risk reduction and auditability for regulated/high-assurance environments.

## 4. Target Architecture

1. Entitlement Plane
- Capability profile generated by backend licensing service.
- One profile maps to runtime guards without manual `AllowedFeatures` mistakes.

2. Policy Plane
- Signed policy bundles with versioning and tenant-scoped activation.
- Mandatory verification in production enterprise profile.

3. Runtime Plane
- Local enforcement engine with clear fail modes and telemetry.
- Tenant-isolated counters, audit chain, anti-replay nonce handling.

4. Governance Plane
- Approval workflow (maker-checker), diff review, blast-radius checks.
- Immutable audit export to SIEM/data lake.

5. Ops Plane
- SLO dashboard, release gates, and enterprise upgrade checks.

## 5. Proposed Phases

## Phase E0 - Capability Model Unification
- Define capability schema (`auth.rbac_plus`, `tenancy.strict`, `rules.runtime`, `audit.remote`, etc.).
- Add resolver mapping from capability -> runtime feature/action checks.
- Backward compatibility for existing `AllowedFeatures`.

Exit criteria:
- No manual action-key management required for new paid customers.

### E0 Implementation Update (2026-02-21)

Status: Completed (runtime + tests + docs)

Delivered:

- Added runtime capability resolver in `src/Muonroi.BuildingBlock/Shared/License/LicenseCapabilityResolver.cs`.
- Migrated `LicenseState.HasFeature` to capability-based resolution while preserving legacy feature keys.
- Added compatibility tests in `tests/Muonroi.BuildingBlock.Test/LicenseCapabilityResolverTests.cs`.
- Published capability schema and migration notes in `docs/license-capability-model.md`.

Behavioral result:

- Paid tiers no longer require manual action keys (`api.*`, `db.*`, `http.*`) in `AllowedFeatures`.
- Existing signed payloads using legacy keys continue to work.
- Invalid license states still degrade to Free baseline only.

## Phase E1 - License and Policy Control Plane (MVP)
- Service APIs: issue/revoke license, generate signed policy bundle, tenant assignment.
- Bundle lifecycle: draft, approved, activated, rolled back.
- Version metadata and signing audit trail.

Exit criteria:
- Production customer can operate without hand-editing policy/license JSON.

### E1 Implementation Update (2026-02-21)

Status: Completed (MVP runtime + API extensions + tests + docs)

Delivered:

- Added control-plane models/store/signer/service in `src/Muonroi.BuildingBlock/Shared/ControlPlane/`.
- Added branded developer entrypoints (`M*`) for E1 APIs:
  - `MEnterpriseControlPlaneService`
  - `MControlPlaneEndpointExtensions.MapMEnterpriseControlPlaneEndpoints`
  - `MControlPlaneServiceCollectionExtensions.AddMEnterpriseControlPlane`
- Implemented license lifecycle APIs:
  - issue signed license payload
  - revoke managed license
  - tenant assignment updates
- Implemented policy bundle lifecycle:
  - draft -> approved -> activated -> rolled back
- Added signed audit trail for all write operations (SHA-256 hash + RSA-SHA256 signature).
- Added E1 test coverage in `tests/Muonroi.BuildingBlock.Test/EnterpriseControlPlaneServiceTests.cs`.
- Added usage guide `docs/control-plane-mvp.md`.

Behavioral result:

- Operators can manage license and policy lifecycle via service/API instead of hand-editing JSON files.
- Policy versions and rollback history are explicit and auditable.

## Phase E2 - Enterprise Secure-by-Default Profile
- Enforce signed policy requirement in enterprise production profile.
- Add explicit fail-closed matrix by capability area.
- Harden cert pinning and endpoint trust policy configuration.

Exit criteria:
- Enterprise profile has deterministic security defaults and documented exceptions.

### E2 Implementation Update (2026-02-21)

Status: Completed (runtime enforcement + remote trust hardening + tests + docs)

Delivered:

- Added enterprise profile evaluator `MEnterpriseSecurityProfile`.
- Added fail-closed matrix `MEnterpriseFailClosedMatrix`.
- Enforced fail-closed policy requirement in `LicenseGuard` for Enterprise+Production.
- Hardened remote path in `ChainSubmitter`:
  - certificate pinning requirement checks
  - trusted endpoint checks
  - required server response signature checks
- Extended `LicenseConfigs` with `Enterprise` secure-default controls.
- Added E2 tests:
  - `tests/Muonroi.BuildingBlock.Test/EnterpriseSecureDefaultsTests.cs`
  - additional E2 remote trust/signature cases in
    `tests/Muonroi.BuildingBlock.Test/AuditTrailChainSubmitterTests.cs`
- Added E2 guide `docs/enterprise-secure-profile-e2.md`.

Behavioral result:

- Enterprise Production now fails closed when signed policy or trust requirements are missing.
- Explicit bypass toggles exist but are opt-in and off by default.

## Phase E3 - Centralized Authorization (PDP Mode)
- Add optional PDP adapter (OPA/OpenFGA style integration point).
- Keep existing local RBAC path as fallback.
- Decision logging with correlation and tenant context.

Exit criteria:
- Microservices can run centralized policy decisions with local fallback.

### E3 Implementation Update (2026-02-21)

Status: Completed (runtime integration + tests + docs)

Delivered:

- Added centralized authorization contracts/config/service in
  `src/Muonroi.BuildingBlock/Shared/Authorization/`:
  - `MPolicyDecisionConfigs`
  - `MPolicyDecisionRequest` / `MPolicyDecisionResult`
  - `IMPolicyDecisionService` / `MPolicyDecisionService`
- Added DI wiring in `InfrastructureExtensions` via `AddMPolicyDecision(...)`.
- Integrated PDP flow into both authorization filters:
  - `PermissionFilter<TPermission>`
  - `AuthorizePermissionFilter<TDbContext>`
- Added failure-mode controls:
  - `FallbackToLocal`
  - `Deny` (fail-closed on remote decision failure)
- Added decision logs with tenant/correlation/action/resource context.
- Added E3 tests:
  - `tests/Muonroi.BuildingBlock.Test/MPolicyDecisionServiceTests.cs`
  - `tests/Muonroi.BuildingBlock.Test/PermissionFilterPdpModeTests.cs`
  - `tests/Muonroi.BuildingBlock.Test/AuthorizePermissionFilterPdpModeTests.cs`
- Added E3 guide `docs/enterprise-centralized-authorization-e3.md`.

Behavioral result:

- Services can externalize authorization to OPA/OpenFGA-style PDP while retaining safe local RBAC fallback.
- Operators can choose deterministic fail-open-to-local or fail-closed-on-error behavior per environment.

## Phase E4 - Compliance and Audit Productization
- Immutable export pipeline for audit trail and policy events.
- Evidence pack generation for compliance audits.
- Retention policies and tamper-evidence verification tooling.

Exit criteria:
- Audit team can produce verifiable evidence without custom scripting.

### E4 Implementation Update (2026-02-21)

Status: Completed (runtime + API + tests + docs)

Delivered:

- Added E4 compliance module in `src/Muonroi.BuildingBlock/Shared/Compliance/`:
  - `MComplianceContracts`
  - `IMComplianceExportService` / `MComplianceExportService`
  - `IMComplianceEvidencePackService` / `MComplianceEvidencePackService`
  - `MComplianceExportHostedService`
  - `MComplianceEndpointExtensions`
- Extended `LicenseConfigs` with `MComplianceConfigs` for export/evidence/retention controls.
- Wired compliance services in `LicenseServiceCollectionExtensions`.
- Implemented immutable export with:
  - append-only NDJSON output,
  - hash-chain (`PreviousHash` + `RecordHash`) continuity,
  - incremental checkpoints for resume-safe exports.
- Implemented evidence packs with:
  - filterable export selection,
  - summary + verification payload,
  - pack hash + signature.
- Added retention pruning for generated evidence-pack artifacts.
- Added E4 tests:
  - `tests/Muonroi.BuildingBlock.Test/MComplianceExportServiceTests.cs`
  - `tests/Muonroi.BuildingBlock.Test/MComplianceEvidencePackServiceTests.cs`
- Added E4 guide `docs/enterprise-compliance-e4.md`.

Behavioral result:

- Audit teams can export, verify, and package compliance evidence without custom scripts.
- Tamper detection is deterministic via hash-chain validation and verification endpoints.

## Phase E5 - Enterprise Operations Package
- SLO presets and health gates for gRPC/message-bus/audit-trail paths.
- Upgrade compatibility checker (breaking config/license policy diff checks).
- LTS channel and release process playbook.

Exit criteria:
- Enterprise upgrade and operations become repeatable and low-risk.

### E5 Implementation Update (2026-02-21)

Status: Completed (runtime + scripts + tests + docs)

Delivered:

- Added E5 enterprise operations module in `src/Muonroi.BuildingBlock/Shared/Operations/`:
  - `MUpgradeCompatibilityContracts`
  - `IMUpgradeCompatibilityService` / `MUpgradeCompatibilityService`
  - `MEnterpriseSloPresetContracts`
  - `IMEnterpriseSloPresetService` / `MEnterpriseSloPresetService`
  - `MEnterpriseOperationsEndpointExtensions`
- Wired E5 services in `LicenseServiceCollectionExtensions`.
- Implemented compatibility checks for:
  - package version transitions (SemVer-aware),
  - license capability drift,
  - policy enforcement/quotas regressions,
  - license configuration regressions (signed policy, audit chain, compliance, secure defaults).
- Added SLO preset package artifacts:
  - `deploy/enterprise/slo-presets/balanced.json`
  - `deploy/enterprise/slo-presets/strict.json`
  - `deploy/enterprise/slo-presets/regulated.json`
- Added CI scripts:
  - `scripts/check-enterprise-upgrade-compat.ps1`
  - `scripts/check-enterprise-slo-gates.ps1`
- Added E5 tests:
  - `tests/Muonroi.BuildingBlock.Test/MUpgradeCompatibilityServiceTests.cs`
  - `tests/Muonroi.BuildingBlock.Test/MEnterpriseSloPresetServiceTests.cs`
- Added E5 guide `docs/enterprise-operations-e5.md`.

Behavioral result:

- Enterprise release pipelines can enforce upgrade compatibility and SLO gates deterministically.
- Operations teams now have standard presets and runbook-backed release criteria.

## 6. Program Status

All planned enterprise phases (E0-E5) are now implemented.

Current recommendation:

1) maintain hardening cadence (new tests + migration notes for every enterprise change)
2) expand CI adoption across all templates/repositories
3) track production SLO drift and recalibrate presets quarterly
